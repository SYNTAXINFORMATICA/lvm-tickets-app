{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/code/sentry/lvm-tickets-app/lib/db.ts"],"sourcesContent":["import { Pool } from 'pg';\n\n// Create a singleton connection pool\nlet pool: Pool | null = null;\n\nexport function getPool() {\n  if (!pool) {\n    pool = new Pool({\n      connectionString: process.env.DATABASE_URL,\n      ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : undefined,\n      max: 20,\n      idleTimeoutMillis: 30000,\n      connectionTimeoutMillis: 2000,\n    });\n  }\n  return pool;\n}\n\nexport async function query(text: string, params?: any[]) {\n  const pool = getPool();\n  const start = Date.now();\n  try {\n    const res = await pool.query(text, params);\n    const duration = Date.now() - start;\n    console.log('[v0] Executed query', { text, duration, rows: res.rowCount });\n    return res;\n  } catch (error) {\n    console.error('[v0] Database query error:', error);\n    throw error;\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;;;;;;AAEA,qCAAqC;AACrC,IAAI,OAAoB;AAEjB,SAAS;IACd,IAAI,CAAC,MAAM;QACT,OAAO,IAAI,4GAAI,CAAC;YACd,kBAAkB,QAAQ,GAAG,CAAC,YAAY;YAC1C,KAAK,sCAAwC,0BAAgC;YAC7E,KAAK;YACL,mBAAmB;YACnB,yBAAyB;QAC3B;IACF;IACA,OAAO;AACT;AAEO,eAAe,MAAM,IAAY,EAAE,MAAc;IACtD,MAAM,OAAO;IACb,MAAM,QAAQ,KAAK,GAAG;IACtB,IAAI;QACF,MAAM,MAAM,MAAM,KAAK,KAAK,CAAC,MAAM;QACnC,MAAM,WAAW,KAAK,GAAG,KAAK;QAC9B,QAAQ,GAAG,CAAC,uBAAuB;YAAE;YAAM;YAAU,MAAM,IAAI,QAAQ;QAAC;QACxE,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,MAAM;IACR;AACF"}},
    {"offset": {"line": 112, "column": 0}, "map": {"version":3,"sources":["file:///C:/code/sentry/lvm-tickets-app/lib/auth.ts"],"sourcesContent":["import { compare, hash } from 'bcryptjs';\nimport { SignJWT, jwtVerify } from 'jose';\nimport { cookies } from 'next/headers';\n\nconst secret = new TextEncoder().encode(process.env.SESSION_SECRET || 'default-secret-change-this');\n\nexport interface User {\n  id: number;\n  cedula: string;\n  name: string;\n  role: 'administrador' | 'analista' | 'ingeniero';\n  email: string;\n}\n\nexport async function hashPassword(password: string): Promise<string> {\n  return hash(password, 10);\n}\n\nexport async function verifyPassword(password: string, hashedPassword: string): Promise<boolean> {\n  return compare(password, hashedPassword);\n}\n\nexport async function createSession(user: User) {\n  const token = await new SignJWT({ user })\n    .setProtectedHeader({ alg: 'HS256' })\n    .setIssuedAt()\n    .setExpirationTime('24h')\n    .sign(secret);\n\n  (await cookies()).set('session', token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    maxAge: 60 * 60 * 24, // 24 hours\n    path: '/',\n  });\n}\n\nexport async function getSession(): Promise<User | null> {\n  const cookieStore = await cookies();\n  const token = cookieStore.get('session');\n\n  if (!token) return null;\n\n  try {\n    const verified = await jwtVerify(token.value, secret);\n    return verified.payload.user as User;\n  } catch (error) {\n    return null;\n  }\n}\n\nexport async function deleteSession() {\n  (await cookies()).delete('session');\n}\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;AACA;AAAA;AACA;;;;AAEA,MAAM,SAAS,IAAI,cAAc,MAAM,CAAC,QAAQ,GAAG,CAAC,cAAc,IAAI;AAU/D,eAAe,aAAa,QAAgB;IACjD,OAAO,IAAA,8KAAI,EAAC,UAAU;AACxB;AAEO,eAAe,eAAe,QAAgB,EAAE,cAAsB;IAC3E,OAAO,IAAA,iLAAO,EAAC,UAAU;AAC3B;AAEO,eAAe,cAAc,IAAU;IAC5C,MAAM,QAAQ,MAAM,IAAI,qMAAO,CAAC;QAAE;IAAK,GACpC,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,WAAW,GACX,iBAAiB,CAAC,OAClB,IAAI,CAAC;IAER,CAAC,MAAM,IAAA,+KAAO,GAAE,EAAE,GAAG,CAAC,WAAW,OAAO;QACtC,UAAU;QACV,QAAQ,oDAAyB;QACjC,UAAU;QACV,QAAQ,KAAK,KAAK;QAClB,MAAM;IACR;AACF;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,+KAAO;IACjC,MAAM,QAAQ,YAAY,GAAG,CAAC;IAE9B,IAAI,CAAC,OAAO,OAAO;IAEnB,IAAI;QACF,MAAM,WAAW,MAAM,IAAA,yMAAS,EAAC,MAAM,KAAK,EAAE;QAC9C,OAAO,SAAS,OAAO,CAAC,IAAI;IAC9B,EAAE,OAAO,OAAO;QACd,OAAO;IACT;AACF;AAEO,eAAe;IACpB,CAAC,MAAM,IAAA,+KAAO,GAAE,EAAE,MAAM,CAAC;AAC3B"}},
    {"offset": {"line": 172, "column": 0}, "map": {"version":3,"sources":["file:///C:/code/sentry/lvm-tickets-app/app/api/tickets/%5Bid%5D/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { query } from '@/lib/db';\nimport { getSession } from '@/lib/auth';\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const user = await getSession();\n    if (!user) {\n      return NextResponse.json({ error: 'No autenticado' }, { status: 401 });\n    }\n\n    const { id } = await params;\n    const result = await query(\n      `SELECT t.*, \n        u1.name as creator_name, u1.email as creator_email,\n        u2.name as assigned_name, u2.email as assigned_email,\n        u3.name as closer_name\n      FROM lvm_tickets t\n      LEFT JOIN lvm_users u1 ON t.created_by = u1.id\n      LEFT JOIN lvm_users u2 ON t.assigned_to = u2.id\n      LEFT JOIN lvm_users u3 ON t.closed_by = u3.id\n      WHERE t.id = $1`,\n      [id]\n    );\n\n    if (result.rows.length === 0) {\n      return NextResponse.json({ error: 'Ticket no encontrado' }, { status: 404 });\n    }\n\n    const historyResult = await query(\n      `SELECT h.*, u.name as changed_by_name\n       FROM lvm_ticket_history h\n       LEFT JOIN lvm_users u ON h.changed_by = u.id\n       WHERE h.ticket_id = $1\n       ORDER BY h.created_at DESC`,\n      [id]\n    );\n\n    return NextResponse.json({\n      ticket: result.rows[0],\n      history: historyResult.rows,\n    });\n  } catch (error) {\n    console.error('[v0] Error fetching ticket:', error);\n    return NextResponse.json({ error: 'Error al obtener ticket' }, { status: 500 });\n  }\n}\n\nexport async function PATCH(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const user = await getSession();\n    if (!user) {\n      return NextResponse.json({ error: 'No autenticado' }, { status: 401 });\n    }\n\n    if (user.role !== 'administrador' && user.role !== 'ingeniero') {\n      return NextResponse.json({ error: 'Sin permisos' }, { status: 403 });\n    }\n\n    const { id } = await params;\n    const updates = await request.json();\n\n    const allowedFields = ['title', 'description', 'priority', 'status', 'resolution', 'assigned_to'];\n    const fields = Object.keys(updates).filter(key => allowedFields.includes(key));\n\n    if (fields.length === 0) {\n      return NextResponse.json({ error: 'No hay campos para actualizar' }, { status: 400 });\n    }\n\n    const setClauses = fields.map((field, index) => `${field} = $${index + 2}`).join(', ');\n    const values = fields.map(field => updates[field]);\n\n    // If closing ticket, add closed_at and closed_by\n    if (updates.status === 'cerrado') {\n      const result = await query(\n        `UPDATE lvm_tickets SET ${setClauses}, closed_at = NOW(), closed_by = $${fields.length + 2}, updated_at = NOW()\n         WHERE id = $1 RETURNING *`,\n        [id, ...values, user.id]\n      );\n\n      if (result.rows.length === 0) {\n        return NextResponse.json({ error: 'Ticket no encontrado' }, { status: 404 });\n      }\n\n      await query(\n        'INSERT INTO lvm_ticket_history (ticket_id, action, changed_by, new_value) VALUES ($1, $2, $3, $4)',\n        [id, 'closed', user.id, JSON.stringify({ closed_by: user.name })]\n      );\n\n      return NextResponse.json({ ticket: result.rows[0] });\n    }\n\n    const result = await query(\n      `UPDATE lvm_tickets SET ${setClauses}, updated_at = NOW() WHERE id = $1 RETURNING *`,\n      [id, ...values]\n    );\n\n    if (result.rows.length === 0) {\n      return NextResponse.json({ error: 'Ticket no encontrado' }, { status: 404 });\n    }\n\n    await query(\n      'INSERT INTO lvm_ticket_history (ticket_id, action, changed_by, new_value) VALUES ($1, $2, $3, $4)',\n      [id, 'updated', user.id, JSON.stringify(updates)]\n    );\n\n    return NextResponse.json({ ticket: result.rows[0] });\n  } catch (error) {\n    console.error('[v0] Error updating ticket:', error);\n    return NextResponse.json({ error: 'Error al actualizar ticket' }, { status: 500 });\n  }\n}\n\nexport async function DELETE(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const user = await getSession();\n    if (!user) {\n      return NextResponse.json({ error: 'No autenticado' }, { status: 401 });\n    }\n\n    if (user.role !== 'administrador') {\n      return NextResponse.json({ error: 'Solo administradores pueden eliminar' }, { status: 403 });\n    }\n\n    const { id } = await params;\n\n    await query('DELETE FROM lvm_ticket_history WHERE ticket_id = $1', [id]);\n    \n    const result = await query('DELETE FROM lvm_tickets WHERE id = $1 RETURNING *', [id]);\n\n    if (result.rows.length === 0) {\n      return NextResponse.json({ error: 'Ticket no encontrado' }, { status: 404 });\n    }\n\n    return NextResponse.json({ success: true });\n  } catch (error) {\n    console.error('[v0] Error deleting ticket:', error);\n    return NextResponse.json({ error: 'Error al eliminar ticket' }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}