{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/code/sentry/lvm-tickets-app/lib/db.ts"],"sourcesContent":["import { Pool } from 'pg';\n\n// Create a singleton connection pool\nlet pool: Pool | null = null;\n\nexport function getPool() {\n  if (!pool) {\n    pool = new Pool({\n      connectionString: process.env.DATABASE_URL,\n      ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : undefined,\n      max: 20,\n      idleTimeoutMillis: 30000,\n      connectionTimeoutMillis: 2000,\n    });\n  }\n  return pool;\n}\n\nexport async function query(text: string, params?: any[]) {\n  const pool = getPool();\n  const start = Date.now();\n  try {\n    const res = await pool.query(text, params);\n    const duration = Date.now() - start;\n    console.log('[v0] Executed query', { text, duration, rows: res.rowCount });\n    return res;\n  } catch (error) {\n    console.error('[v0] Database query error:', error);\n    throw error;\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;;;;;;AAEA,qCAAqC;AACrC,IAAI,OAAoB;AAEjB,SAAS;IACd,IAAI,CAAC,MAAM;QACT,OAAO,IAAI,4GAAI,CAAC;YACd,kBAAkB,QAAQ,GAAG,CAAC,YAAY;YAC1C,KAAK,sCAAwC,0BAAgC;YAC7E,KAAK;YACL,mBAAmB;YACnB,yBAAyB;QAC3B;IACF;IACA,OAAO;AACT;AAEO,eAAe,MAAM,IAAY,EAAE,MAAc;IACtD,MAAM,OAAO;IACb,MAAM,QAAQ,KAAK,GAAG;IACtB,IAAI;QACF,MAAM,MAAM,MAAM,KAAK,KAAK,CAAC,MAAM;QACnC,MAAM,WAAW,KAAK,GAAG,KAAK;QAC9B,QAAQ,GAAG,CAAC,uBAAuB;YAAE;YAAM;YAAU,MAAM,IAAI,QAAQ;QAAC;QACxE,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,MAAM;IACR;AACF"}},
    {"offset": {"line": 112, "column": 0}, "map": {"version":3,"sources":["file:///C:/code/sentry/lvm-tickets-app/lib/auth.ts"],"sourcesContent":["import { compare, hash } from 'bcryptjs';\nimport { SignJWT, jwtVerify } from 'jose';\nimport { cookies } from 'next/headers';\n\nconst secret = new TextEncoder().encode(process.env.SESSION_SECRET || 'default-secret-change-this');\n\nexport interface User {\n  id: number;\n  cedula: string;\n  name: string;\n  role: 'administrador' | 'analista' | 'ingeniero';\n  email: string;\n}\n\nexport async function hashPassword(password: string): Promise<string> {\n  return hash(password, 10);\n}\n\nexport async function verifyPassword(password: string, hashedPassword: string): Promise<boolean> {\n  return compare(password, hashedPassword);\n}\n\nexport async function createSession(user: User) {\n  const token = await new SignJWT({ user })\n    .setProtectedHeader({ alg: 'HS256' })\n    .setIssuedAt()\n    .setExpirationTime('24h')\n    .sign(secret);\n\n  (await cookies()).set('session', token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    maxAge: 60 * 60 * 24, // 24 hours\n    path: '/',\n  });\n}\n\nexport async function getSession(): Promise<User | null> {\n  const cookieStore = await cookies();\n  const token = cookieStore.get('session');\n\n  if (!token) return null;\n\n  try {\n    const verified = await jwtVerify(token.value, secret);\n    return verified.payload.user as User;\n  } catch (error) {\n    return null;\n  }\n}\n\nexport async function deleteSession() {\n  (await cookies()).delete('session');\n}\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;AACA;AAAA;AACA;;;;AAEA,MAAM,SAAS,IAAI,cAAc,MAAM,CAAC,QAAQ,GAAG,CAAC,cAAc,IAAI;AAU/D,eAAe,aAAa,QAAgB;IACjD,OAAO,IAAA,8KAAI,EAAC,UAAU;AACxB;AAEO,eAAe,eAAe,QAAgB,EAAE,cAAsB;IAC3E,OAAO,IAAA,iLAAO,EAAC,UAAU;AAC3B;AAEO,eAAe,cAAc,IAAU;IAC5C,MAAM,QAAQ,MAAM,IAAI,qMAAO,CAAC;QAAE;IAAK,GACpC,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,WAAW,GACX,iBAAiB,CAAC,OAClB,IAAI,CAAC;IAER,CAAC,MAAM,IAAA,+KAAO,GAAE,EAAE,GAAG,CAAC,WAAW,OAAO;QACtC,UAAU;QACV,QAAQ,oDAAyB;QACjC,UAAU;QACV,QAAQ,KAAK,KAAK;QAClB,MAAM;IACR;AACF;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,+KAAO;IACjC,MAAM,QAAQ,YAAY,GAAG,CAAC;IAE9B,IAAI,CAAC,OAAO,OAAO;IAEnB,IAAI;QACF,MAAM,WAAW,MAAM,IAAA,yMAAS,EAAC,MAAM,KAAK,EAAE;QAC9C,OAAO,SAAS,OAAO,CAAC,IAAI;IAC9B,EAAE,OAAO,OAAO;QACd,OAAO;IACT;AACF;AAEO,eAAe;IACpB,CAAC,MAAM,IAAA,+KAAO,GAAE,EAAE,MAAM,CAAC;AAC3B"}},
    {"offset": {"line": 170, "column": 0}, "map": {"version":3,"sources":["file:///C:/code/sentry/lvm-tickets-app/lib/azure-openai.ts"],"sourcesContent":["import { AzureOpenAI } from 'openai';\n\nlet azureClient: AzureOpenAI | null = null;\n\nexport function getAzureOpenAIClient() {\n  if (!azureClient) {\n    azureClient = new AzureOpenAI({\n      apiKey: process.env.AZURE_OPENAI_API_KEY,\n      endpoint: process.env.AZURE_OPENAI_ENDPOINT,\n      apiVersion: process.env.AZURE_OPENAI_API_VERSION || '2024-02-15-preview',\n    });\n  }\n  return azureClient;\n}\n\nexport async function analyzeTicket(title: string, description: string, application: string) {\n  const client = getAzureOpenAIClient();\n  \n  const systemPrompt = `Eres un ingeniero de soporte técnico nivel 1 experto en:\n- SharePoint Online (configuración, permisos, bibliotecas, listas, flujos de trabajo)\n- Facturador (aplicación .NET con base de datos SQL para facturación)\n\nTu trabajo es:\n1. Analizar el problema reportado\n2. Determinar la prioridad (Urgente, Media, Normal)\n3. Intentar resolver el problema si está en tu alcance (nivel 1)\n4. Si puedes resolverlo, proporciona una solución clara y cierra el ticket\n5. Si no puedes resolverlo, escala a nivel 2 explicando por qué\n\nResponde en formato JSON:\n{\n  \"priority\": \"Urgente\" | \"Media\" | \"Normal\",\n  \"can_resolve\": boolean,\n  \"support_level\": 1 | 2,\n  \"resolution\": \"solución detallada si can_resolve es true, o null\",\n  \"escalation_reason\": \"razón de escalamiento si can_resolve es false, o null\",\n  \"analysis\": \"análisis del problema\"\n}`;\n\n  try {\n    const response = await client.chat.completions.create({\n      model: process.env.AZURE_OPENAI_DEPLOYMENT_NAME || 'gpt-5-chat-formacion',\n      messages: [\n        { role: 'system', content: systemPrompt },\n        { \n          role: 'user', \n          content: `Aplicación: ${application}\\nTítulo: ${title}\\nDescripción: ${description}` \n        },\n      ],\n      temperature: 0.3,\n      max_tokens: 1000,\n      response_format: { type: 'json_object' },\n    });\n\n    const result = JSON.parse(response.choices[0].message.content || '{}');\n    console.log('[v0] AI Analysis completed:', result);\n    return result;\n  } catch (error) {\n    console.error('[v0] Azure OpenAI error:', error);\n    // Fallback response if AI fails\n    return {\n      priority: 'Media',\n      can_resolve: false,\n      support_level: 2,\n      resolution: null,\n      escalation_reason: 'Error en el análisis de IA. Requiere revisión manual.',\n      analysis: 'El sistema no pudo analizar automáticamente este ticket.',\n    };\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;;AAEA,IAAI,cAAkC;AAE/B,SAAS;IACd,IAAI,CAAC,aAAa;QAChB,cAAc,IAAI,oLAAW,CAAC;YAC5B,QAAQ,QAAQ,GAAG,CAAC,oBAAoB;YACxC,UAAU,QAAQ,GAAG,CAAC,qBAAqB;YAC3C,YAAY,QAAQ,GAAG,CAAC,wBAAwB,IAAI;QACtD;IACF;IACA,OAAO;AACT;AAEO,eAAe,cAAc,KAAa,EAAE,WAAmB,EAAE,WAAmB;IACzF,MAAM,SAAS;IAEf,MAAM,eAAe,CAAC;;;;;;;;;;;;;;;;;;;CAmBvB,CAAC;IAEA,IAAI;QACF,MAAM,WAAW,MAAM,OAAO,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC;YACpD,OAAO,QAAQ,GAAG,CAAC,4BAA4B,IAAI;YACnD,UAAU;gBACR;oBAAE,MAAM;oBAAU,SAAS;gBAAa;gBACxC;oBACE,MAAM;oBACN,SAAS,CAAC,YAAY,EAAE,YAAY,UAAU,EAAE,MAAM,eAAe,EAAE,aAAa;gBACtF;aACD;YACD,aAAa;YACb,YAAY;YACZ,iBAAiB;gBAAE,MAAM;YAAc;QACzC;QAEA,MAAM,SAAS,KAAK,KAAK,CAAC,SAAS,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,OAAO,IAAI;QACjE,QAAQ,GAAG,CAAC,+BAA+B;QAC3C,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,gCAAgC;QAChC,OAAO;YACL,UAAU;YACV,aAAa;YACb,eAAe;YACf,YAAY;YACZ,mBAAmB;YACnB,UAAU;QACZ;IACF;AACF"}},
    {"offset": {"line": 253, "column": 0}, "map": {"version":3,"sources":["file:///C:/code/sentry/lvm-tickets-app/app/api/tickets/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { query } from '@/lib/db';\nimport { getSession } from '@/lib/auth';\nimport { analyzeTicket } from '@/lib/azure-openai';\n\nexport async function GET(request: NextRequest) {\n  try {\n    const user = await getSession();\n    if (!user) {\n      return NextResponse.json({ error: 'No autenticado' }, { status: 401 });\n    }\n\n    const searchParams = request.nextUrl.searchParams;\n    const status = searchParams.get('status');\n    const priority = searchParams.get('priority');\n    const application = searchParams.get('application');\n\n    let sql = `\n      SELECT t.*, \n        u1.name as creator_name, \n        u2.name as assigned_name,\n        u3.name as closer_name\n      FROM lvm_tickets t\n      LEFT JOIN lvm_users u1 ON t.created_by = u1.id\n      LEFT JOIN lvm_users u2 ON t.assigned_to = u2.id\n      LEFT JOIN lvm_users u3 ON t.closed_by = u3.id\n      WHERE 1=1\n    `;\n    const params: any[] = [];\n    let paramCount = 0;\n\n    if (status) {\n      paramCount++;\n      sql += ` AND t.status = $${paramCount}`;\n      params.push(status);\n    }\n\n    if (priority) {\n      paramCount++;\n      sql += ` AND t.priority = $${paramCount}`;\n      params.push(priority);\n    }\n\n    if (application) {\n      paramCount++;\n      sql += ` AND t.application = $${paramCount}`;\n      params.push(application);\n    }\n\n    sql += ' ORDER BY t.created_at DESC';\n\n    const result = await query(sql, params);\n    return NextResponse.json({ tickets: result.rows });\n  } catch (error) {\n    console.error('[v0] Error fetching tickets:', error);\n    return NextResponse.json({ error: 'Error al obtener tickets' }, { status: 500 });\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const user = await getSession();\n    if (!user) {\n      return NextResponse.json({ error: 'No autenticado' }, { status: 401 });\n    }\n\n    const { title, description, application, area } = await request.json();\n\n    if (!title || !description || !application || !area) {\n      return NextResponse.json(\n        { error: 'Todos los campos son requeridos' },\n        { status: 400 }\n      );\n    }\n\n    // Analyze ticket with AI\n    const aiAnalysis = await analyzeTicket(title, description, application);\n\n    const result = await query(\n      `INSERT INTO lvm_tickets (\n        title, description, application, area, priority, status, \n        support_level, created_by, resolution, ai_analysis\n      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10) \n      RETURNING *`,\n      [\n        title,\n        description,\n        application,\n        area,\n        aiAnalysis.priority,\n        aiAnalysis.can_resolve ? 'cerrado' : 'abierto',\n        aiAnalysis.support_level,\n        user.id,\n        aiAnalysis.resolution,\n        aiAnalysis.analysis,\n      ]\n    );\n\n    const ticket = result.rows[0];\n\n    // If AI resolved it, mark it as closed\n    if (aiAnalysis.can_resolve) {\n      await query(\n        'UPDATE lvm_tickets SET closed_at = NOW(), closed_by = $1 WHERE id = $2',\n        [user.id, ticket.id]\n      );\n    }\n\n    await query(\n      'INSERT INTO lvm_ticket_history (ticket_id, action, changed_by, new_value) VALUES ($1, $2, $3, $4)',\n      [ticket.id, 'created', user.id, JSON.stringify(aiAnalysis)]\n    );\n\n    return NextResponse.json({ ticket, aiAnalysis });\n  } catch (error) {\n    console.error('[v0] Error creating ticket:', error);\n    return NextResponse.json({ error: 'Error al crear ticket' }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;;;;;;;;;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,OAAO,MAAM,IAAA,8JAAU;QAC7B,IAAI,CAAC,MAAM;YACT,OAAO,mLAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,MAAM,eAAe,QAAQ,OAAO,CAAC,YAAY;QACjD,MAAM,SAAS,aAAa,GAAG,CAAC;QAChC,MAAM,WAAW,aAAa,GAAG,CAAC;QAClC,MAAM,cAAc,aAAa,GAAG,CAAC;QAErC,IAAI,MAAM,CAAC;;;;;;;;;;IAUX,CAAC;QACD,MAAM,SAAgB,EAAE;QACxB,IAAI,aAAa;QAEjB,IAAI,QAAQ;YACV;YACA,OAAO,CAAC,iBAAiB,EAAE,YAAY;YACvC,OAAO,IAAI,CAAC;QACd;QAEA,IAAI,UAAU;YACZ;YACA,OAAO,CAAC,mBAAmB,EAAE,YAAY;YACzC,OAAO,IAAI,CAAC;QACd;QAEA,IAAI,aAAa;YACf;YACA,OAAO,CAAC,sBAAsB,EAAE,YAAY;YAC5C,OAAO,IAAI,CAAC;QACd;QAEA,OAAO;QAEP,MAAM,SAAS,MAAM,IAAA,uJAAK,EAAC,KAAK;QAChC,OAAO,mLAAY,CAAC,IAAI,CAAC;YAAE,SAAS,OAAO,IAAI;QAAC;IAClD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,OAAO,mLAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA2B,GAAG;YAAE,QAAQ;QAAI;IAChF;AACF;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,IAAA,8JAAU;QAC7B,IAAI,CAAC,MAAM;YACT,OAAO,mLAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,MAAM,EAAE,KAAK,EAAE,WAAW,EAAE,WAAW,EAAE,IAAI,EAAE,GAAG,MAAM,QAAQ,IAAI;QAEpE,IAAI,CAAC,SAAS,CAAC,eAAe,CAAC,eAAe,CAAC,MAAM;YACnD,OAAO,mLAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAkC,GAC3C;gBAAE,QAAQ;YAAI;QAElB;QAEA,yBAAyB;QACzB,MAAM,aAAa,MAAM,IAAA,4KAAa,EAAC,OAAO,aAAa;QAE3D,MAAM,SAAS,MAAM,IAAA,uJAAK,EACxB,CAAC;;;;iBAIU,CAAC,EACZ;YACE;YACA;YACA;YACA;YACA,WAAW,QAAQ;YACnB,WAAW,WAAW,GAAG,YAAY;YACrC,WAAW,aAAa;YACxB,KAAK,EAAE;YACP,WAAW,UAAU;YACrB,WAAW,QAAQ;SACpB;QAGH,MAAM,SAAS,OAAO,IAAI,CAAC,EAAE;QAE7B,uCAAuC;QACvC,IAAI,WAAW,WAAW,EAAE;YAC1B,MAAM,IAAA,uJAAK,EACT,0EACA;gBAAC,KAAK,EAAE;gBAAE,OAAO,EAAE;aAAC;QAExB;QAEA,MAAM,IAAA,uJAAK,EACT,qGACA;YAAC,OAAO,EAAE;YAAE;YAAW,KAAK,EAAE;YAAE,KAAK,SAAS,CAAC;SAAY;QAG7D,OAAO,mLAAY,CAAC,IAAI,CAAC;YAAE;YAAQ;QAAW;IAChD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,OAAO,mLAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC7E;AACF"}}]
}